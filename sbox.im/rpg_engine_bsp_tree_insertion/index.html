<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="http://sbox.im/sb.css">
<link rel="stylesheet" type="text/css" href="http://sbox.im/syntax.min.css">
<script src="http://sbox.im/tree.min.js" type="text/javascript"></script>
<script src="http://sbox.im/mountain.min.js" type="text/javascript"></script>
<script src="http://sbox.im/jquery.min.js" type="text/javascript"></script>

<script type="text/javascript" src="http://sbox.im/console/Console.min.js"></script>
<script type="text/javascript" src="http://sbox.im/console/SBConsole.min.js"></script>
<script type="text/javascript" src="http://sbox.im/console/consoleClient.min.js"></script>
<script type="text/javascript" src="http://sbox.im/console/Sbox.min.js"></script>
<script type="text/javascript" src="http://sbox.im/console/Interpreter.min.js"></script>

<title>stevebob.net...RPG Engine: BSP Tree Insertion</title>
<link rel="icon" type="image/png" href="http://stevebob.net/favicon.png">
</head>
<body onload="new TreeDemo().start_tree();mountain_main();initConsole()">


<div id="tree">
<div id="treeclick" onclick="new TreeDemo().start_tree()">
</div>
<canvas id="screen" width=300 height=200 style="position:absolute;left:-30px;z-index:2"></canvas>
</div>

<div id="mountain_container">

<div id="mountain_click" onclick="mountain_reset()"></div>
<canvas id="mountain" height=130 width=500>
</canvas>

</div>


<div id="sky">
</div>
<div id="skymain">
<div id="skycontent">

                <input id="consoleinput"
                />
            <div id="consoleoutput">
                <p style="font-size:30px;margin:0px;">
                <br />
                </p>
                <p style="font-size:40px">stevebob.net...</p>
            </div>

            
</div>
</div>

 




<div id="linkbar">

<div id="linkbarmain">

<div id="linkbarcontents">
<ul class="links">

<div class="bannerlinkcontainer">

<li>
<a href="http://sbox.im/">
<div class="bannerlink">
Home</div>
</a>
</li>
</div>

<div class="bannerlinkcontainer">

<li>
<a href="http://sbox.im/about">
<div class="bannerlink">
About</div>
</a>
</li>
</div>

<div class="bannerlinkcontainer">

<li>
<a href="http://sbox.im/apps">
<div class="bannerlink">
Apps</div>
</a>
</li>

<div class="dropMenu">
<div class="dropMenuContainee" style="width: 700px">

<ul class="links">


<div class="app-column">
    <li><a class="menuLink" href="http://sbox.im/3dhero">3D Hero</a></li>
    <li><a class="menuLink" href="http://sbox.im/3dtesla">3D Tesla</a></li>
    <li><a class="menuLink" href="http://sbox.im/4dhero">4D Hero</a></li>
    <li><a class="menuLink" href="http://sbox.im/bsp">BSP Demo</a></li>
    <li><a class="menuLink" href="http://sbox.im/bsp-wireframe">BSP Wireframe</a></li>
    <li><a class="menuLink" href="http://sbox.im/backface-culling">Backface Culling</a></li>
    <li><a class="menuLink" href="http://sbox.im/backface-culling-2-cubes">Backface Culling 2 Cubes</a></li>
    <li><a class="menuLink" href="http://sbox.im/boxillusion">Box Illusion</a></li>
    <li><a class="menuLink" href="http://sbox.im/button">Button</a></li>
    <li><a class="menuLink" href="http://comp1917.ripenetwork.com">COMP1917 in a Day</a></li>
    <li><a class="menuLink" href="http://sbox.im/cell">Cell</a></li>
    <li><a class="menuLink" href="http://sbox.im/clipping-plane">Clipping Plane</a></li>
    <li><a class="menuLink" href="http://sbox.im/convexhull-demo">Convex Hull Demo</a></li>
</div>

<div class="app-column">
    <li><a class="menuLink" href="http://sbox.im/dots">Dots</a></li>
    <li><a class="menuLink" href="http://sbox.im/fractal">Fractal</a></li>
    <li><a class="menuLink" href="http://sbox.im/fractalcubes">Fractal Cubes</a></li>
    <li><a class="menuLink" href="http://sbox.im/fractbox">Fractbox</a></li>
    <li><a class="menuLink" href="http://sbox.im/grav">Grav</a></li>
    <li><a class="menuLink" href="http://sbox.im/heart">Heart</a></li>
    <li><a class="menuLink" href="http://sbox.im/hero">Hero</a></li>
    <li><a class="menuLink" href="http://sbox.im/herojs1k">Hero JS1K2014</a></li>
    <li><a class="menuLink" href="http://sbox.im/hyperspace">Hyperspace</a></li>
    <li><a class="menuLink" href="http://sbox.im/iou">IOU</a></li>
    <li><a class="menuLink" href="http://sbox.im/isometric_demo">Isometric Demo</a></li>
    <li><a class="menuLink" href="http://sbox.im/jewels">Jewels</a></li>
    <li><a class="menuLink" href="http://sbox.im/lex">Lex</a></li>
</div>

<div class="app-column">
    <li><a class="menuLink" href="http://sbox.im/lowres">Lowres</a></li>
    <li><a class="menuLink" href="http://sbox.im/mandelbrot">Mandelbrot</a></li>
    <li><a class="menuLink" href="http://sbox.im/matrix">Matrix</a></li>
    <li><a class="menuLink" href="http://sbox.im/merry">Merry</a></li>
    <li><a class="menuLink" href="http://sbox.im/message">Message</a></li>
    <li><a class="menuLink" href="http://sbox.im/metashape">Metashape</a></li>
    <li><a class="menuLink" href="http://sbox.im/pixbox">Pixbox</a></li>
    <li><a class="menuLink" href="http://sbox.im/pixtree">Pixtree</a></li>
    <li><a class="menuLink" href="http://sbox.im/rpg">RPG</a></li>
    <li><a class="menuLink" href="http://sbox.im/rave">Rave</a></li>
    <li><a class="menuLink" href="http://sbox.im/rave_legacy">Rave Legacy</a></li>
    <li><a class="menuLink" href="http://sbox.im/ray">Ray</a></li>
    <li><a class="menuLink" href="http://sbox.im/raycastdemo">Ray Cast Demo</a></li>
</div>

<div class="app-column">
    <li><a class="menuLink" href="http://rsc.stevebob.net">Really Simple Chat</a></li>
    <li><a class="menuLink" href="http://sbox.im/rooms">Rooms</a></li>
    <li><a class="menuLink" href="http://sbox.im/shadows">Shadows</a></li>
    <li><a class="menuLink" href="http://sbox.im/snow">Snow</a></li>
    <li><a class="menuLink" href="http://sbox.im/storm">Storm</a></li>
    <li><a class="menuLink" href="http://sbox.im/tesla">Tesla</a></li>
    <li><a class="menuLink" href="http://sbox.im/tesseract">Tesseract</a></li>
    <li><a class="menuLink" href="http://sbox.im/three">Three</a></li>
    <li><a class="menuLink" href="http://sbox.im/tree">Tree</a></li>
    <li><a class="menuLink" href="http://sbox.im/vines">Vines</a></li>
    <li><a class="menuLink" href="http://sbox.im/wireframe">Wireframe</a></li>
    <li><a class="menuLink" href="http://sbox.im/worms">Worms</a></li>
    <li><a class="menuLink" href="http://sbox.im/xor">XOR</a></li>
</div>

</ul>

</div>
</div>
</div>


<div class="bannerlinkcontainer">

<li>
<a href="http://sbox.im/posts">
<div class="bannerlink">
Posts
</div>
</a>
</li>

<div class="dropMenu">
<div class="dropMenuContainee" style="width: 400px">

<ul class="links">

<div class="post-column">
    <li><a class="menuLink" href="http://sbox.im/reinventing-the-3d-wheel">Reinventing the 3D Wheel</a></li>
    <li><a class="menuLink" href="http://sbox.im/heroes-and-villains">Heroes and Villains</a></li>
    <li><a class="menuLink" href="http://sbox.im/dont-plan-your-trip">Don't Plan Your Trip</a></li>
    <li><a class="menuLink" href="http://sbox.im/confusing-train-adventure">Confusing Train Adventure</a></li>
    <li><a class="menuLink" href="http://sbox.im/thinking-fourth-dimensionally">Thinking Fourth Dimensionally</a></li>
    <li><a class="menuLink" href="http://sbox.im/agda-environment">Agda Programming Environment</a></li>
    <li><a class="menuLink" href="http://sbox.im/framebuffers-and-coffee">Framebuffers and Coffee</a></li>
    <li><a class="menuLink" href="http://sbox.im/all-grown-up">All Grown Up</a></li>
    <li><a class="menuLink" href="http://sbox.im/rpg_engine_bsp_tree_insertion">RPG Engine: BSP Tree Insertion</a></li>
    <li><a class="menuLink" href="http://sbox.im/rpg_engine_intro">RPG Engine: Introduction</a></li>
    <li><a class="menuLink" href="http://sbox.im/existentialcrisis">Existential Crisis</a></li>
    <li><a class="menuLink" href="http://sbox.im/nyak">New York, Alaska</a></li>
    <li><a class="menuLink" href="http://sbox.im/tmo">Toronto, Montreal, Ottawa</a></li>
</div>

<div class="post-column">
    <li><a class="menuLink" href="http://sbox.im/photos1">Exchange: Photos 1</a></li>
    <li><a class="menuLink" href="http://sbox.im/exchange_canada">Exchange: Canada</a></li>
    <li><a class="menuLink" href="http://sbox.im/blog-written-in-perl">This Blog is Written in Perl</a></li>
</div>
</ul>



</div>
</div>


</div>

</ul>


</div>

</div>















</div>

<div id="main">


<div id="leftmain">
<div id="leftlinks" class="sidepane">
<ul class="links">
<li><a class="leftlink" href="http://sbox.im/3dhero">3D Hero</a></li>
<li><a class="leftlink" href="http://sbox.im/3dtesla">3D Tesla</a></li>
<li><a class="leftlink" href="http://sbox.im/4dhero">4D Hero</a></li>
<li><a class="leftlink" href="http://sbox.im/bsp">BSP Demo</a></li>
<li><a class="leftlink" href="http://sbox.im/bsp-wireframe">BSP Wireframe</a></li>
<li><a class="leftlink" href="http://sbox.im/button">Button</a></li>
<li><a class="leftlink" href="http://sbox.im/fractalcubes">Fractal Cubes</a></li>
<li><a class="leftlink" href="http://sbox.im/fractbox">Fractbox</a></li>
<li><a class="leftlink" href="http://sbox.im/heart">Heart</a></li>
<li><a class="leftlink" href="http://sbox.im/hero">Hero</a></li>
<li><a class="leftlink" href="http://sbox.im/herojs1k">Hero JS1K2014</a></li>
<li><a class="leftlink" href="http://sbox.im/hyperspace">Hyperspace</a></li>
<li><a class="leftlink" href="http://sbox.im/iou">IOU</a></li>
<li><a class="leftlink" href="http://sbox.im/isometric_demo">Isometric Demo</a></li>
<li><a class="leftlink" href="http://sbox.im/lex">Lex</a></li>
<li><a class="leftlink" href="http://sbox.im/lowres">Lowres</a></li>
<li><a class="leftlink" href="http://sbox.im/mandelbrot">Mandelbrot</a></li>
<li><a class="leftlink" href="http://sbox.im/metashape">Metashape</a></li>
<li><a class="leftlink" href="http://sbox.im/pixtree">Pixtree</a></li>
<li><a class="leftlink" href="http://sbox.im/rpg">RPG</a></li>
<li><a class="leftlink" href="http://sbox.im/rave_legacy">Rave Legacy</a></li>
<li><a class="leftlink" href="http://sbox.im/rooms">Rooms</a></li>
<li><a class="leftlink" href="http://sbox.im/shadows">Shadows</a></li>
<li><a class="leftlink" href="http://sbox.im/snow">Snow</a></li>
<li><a class="leftlink" href="http://sbox.im/tesla">Tesla</a></li>
<li><a class="leftlink" href="http://sbox.im/tesseract">Tesseract</a></li>
<li><a class="leftlink" href="http://sbox.im/three">Three</a></li>
<li><a class="leftlink" href="http://sbox.im/tree">Tree</a></li>
</ul>
</div>
</div>

<div id="rightmain">

<div id="contact-box">

<a href="https://github.com/stevebob"><img src="http://sbox.im/github.png" alt="Github"></a>
<a href="http://stevebob.net/rss.xml"><img src="http://sbox.im/rss.png" alt="RSS Feed"></a>
<a href="mailto:stephen@sherra.tt"><img src="http://sbox.im/email.png" alt="Email"></a>
<a href="https://www.facebook.com/stephen.sherratt1"><img src="http://sbox.im/facebook.png" alt="Facebook"></a>

</div>

<div id="rightlinks" class="sidepane">
<ul class="links">
<li><a class="right_link" href="http://sbox.im/reinventing-the-3d-wheel">Reinventing the 3D Wheel</a></li>
<li><a class="right_link" href="http://sbox.im/heroes-and-villains">Heroes and Villains</a></li>
<li><a class="right_link" href="http://sbox.im/dont-plan-your-trip">Don't Plan Your Trip</a></li>
<li><a class="right_link" href="http://sbox.im/confusing-train-adventure">Confusing Train Adventure</a></li>
<li><a class="right_link" href="http://sbox.im/thinking-fourth-dimensionally">Thinking Fourth Dimensionally</a></li>
<li><a class="right_link" href="http://sbox.im/agda-environment">Agda Programming Environment</a></li>
<li><a class="right_link" href="http://sbox.im/framebuffers-and-coffee">Framebuffers and Coffee</a></li>
<li><a class="right_link" href="http://sbox.im/all-grown-up">All Grown Up</a></li>
<li><a class="right_link" href="http://sbox.im/rpg_engine_bsp_tree_insertion">RPG Engine: BSP Tree Insertion</a></li>
<li><a class="right_link" href="http://sbox.im/rpg_engine_intro">RPG Engine: Introduction</a></li>
</ul>
</div>


<div id="career" class="sidepane">
<ul class="links">
<li><a class="right_link" href="http://stephen.sherra.tt">Resume (html)</a></li>
<li><a class="right_link" href="/resume/StephenSherrattResume.pdf">Resume (pdf)</a></li>
</ul>
</div>

</div>



<div id="centremain">
<div id="centrecontent">


<div class="post-container">
<div class="heading-container">
<h1>RPG Engine: BSP Tree Insertion</h1>
<div class="under-heading">
2012-10-27 07:23
</div>
</div>
<div class="post-body">

<p>Here’s a quick post about how visible surface detection works, in particular when there are things that move around. Firstly, say you have a bunch of polygons you want to draw, and some obscure the view of others. It’s easy to demonstrate that you can’t simply sort all the polygons into some magical order, then draw them, one after the other, in that order, drawing over anything on the canvas that was previously there. Think about the bottom of a cardboard box. There are 4 rectangles, each partially on top of the other (this drove me crazy when I was a kid). Since the last polygon you draw must be completely visible since there is nothing to obscure it, there can be no last polygon drawn, so simply sorting all the polygons will not suffice.</p>

<p>Enter Binary Space Partition Trees. A BSP Tree is a binary tree like data structure used for visible surface detection. To generate a BSP Tree, start with an empty binary tree, and insert polygons in the following way:</p>

<p>insert(p, node) if the node is empty then store p in node else if p is entirely behind the node’s polygon insert(p, right subtree of node) else if p is entirely in front of the node’s polygon insert(p, left subtree of node) else split p into pfront and pbehind such that pfront is entirely in front of the node’s polygon and pbehind is entirely behind it insert(pfront, left subtree of node) insert(pbehind, right subtree of node)</p>

<p>Now, for our purposes, the polygons we are going to draw all face the view point, so the view point is always in front of every polygon. Suffice it to say (and wikipedia BSP Trees if you want to know more), that in this special case, if you draw all the polygons in the right subtree by this method, then draw the root node’s polygon, then draw all the polygons in the left subtree by the same method, the correct parts of all polygons are visible.</p>
<h2>Sounds cool - what's the catch?</h2>
<p>The whole “splitting polygons in two” deal turns out to be a bit of a problem. Since it can occur at every stage of every polygon insertion, the total number of polygons gets really big, which slows down the drawing process, and since that is something that happens at every frame, his is bad news. The order in which polygons are inserted affects the resulting tree. In practice, to generate a “good” tree, where little splitting occurs, many trees are generated with randomized orders if polygon insertion, and the best tree is taken, stored, and just loaded when the program is run.</p>

<p>So far, for this program, I generated the tree on paper and hard coded it into the XML file storing the world. If the following labels are applied to walls</p>

</div>
<div class="post-image-centre-container">

<table class="image-centre">
<caption class="image-caption"></caption>
<tr><td>
<img class="post-image-centre" src="http://sbox.im/rpg_engine_bsp_tree_insertion/bridge0.11/labelled.png" alt="labelled"  style="width:100%" />
</td></tr>
</table>

</div>

<div class="post-body">

<p>…then the BSP Tree might look like</p>

</div>
<div class="post-image-centre-container">

<table class="image-centre">
<caption class="image-caption"></caption>
<tr><td>
<img class="post-image-centre" src="http://sbox.im/rpg_engine_bsp_tree_insertion/bridge0.11/bsp.png" alt="bsp" />
</td></tr>
</table>

</div>

<div class="post-body">

<p>Since BSP Trees work on the notion of some polygons being in front of other polygons, they are complicated when polygons move. This demonstration includes a movable avatar (WASD) that is included in the draw order output by the BSP Tree. It turns out there is a simple way to do this. In each frame, a copy of the BSP Tree is made, and the avatar’s polygon is inserted as per the algorithm described above. This can be done for each movable polygon.</p>
<iframe src="http://sbox.im/rpg_engine_bsp_tree_insertion/bridge0.11/" style="width:1000px;height:740px;border:0px;margin-left:-170px"> </iframe>
</div>
</div>



</div>
</div>

<div id="footer">
Copyright &copy; 2014 stevebob.net
</div>
</div>


</body>
</html>
